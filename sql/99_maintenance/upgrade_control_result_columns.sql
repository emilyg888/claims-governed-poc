USE DATABASE CLAIMS_POC;
USE SCHEMA CTRL;

-- Non-destructive schema sync for legacy CONTROL_RESULT tables.
ALTER TABLE CONTROL_RESULT ADD COLUMN IF NOT EXISTS BATCH_DATE DATE;
ALTER TABLE CONTROL_RESULT ADD COLUMN IF NOT EXISTS CONTROL_NAME STRING;
ALTER TABLE CONTROL_RESULT ADD COLUMN IF NOT EXISTS STATUS STRING;
ALTER TABLE CONTROL_RESULT ADD COLUMN IF NOT EXISTS TOTAL_COUNT NUMBER;
ALTER TABLE CONTROL_RESULT ADD COLUMN IF NOT EXISTS FAIL_COUNT NUMBER;
ALTER TABLE CONTROL_RESULT ADD COLUMN IF NOT EXISTS VARIANCE FLOAT;
ALTER TABLE CONTROL_RESULT ADD COLUMN IF NOT EXISTS SEVERITY STRING;
ALTER TABLE CONTROL_RESULT ADD COLUMN IF NOT EXISTS BLOCKING_FLAG BOOLEAN;
ALTER TABLE CONTROL_RESULT ADD COLUMN IF NOT EXISTS DETAILS STRING;
ALTER TABLE CONTROL_RESULT ADD COLUMN IF NOT EXISTS EXECUTED_SQL_HASH STRING;
ALTER TABLE CONTROL_RESULT ADD COLUMN IF NOT EXISTS EXECUTED_AT TIMESTAMP_NTZ;
ALTER TABLE CONTROL_RESULT ADD COLUMN IF NOT EXISTS EXECUTED_TS TIMESTAMP_NTZ;

-- Backfill EXECUTED_AT from EXECUTED_TS for legacy rows where possible.
UPDATE CONTROL_RESULT
SET EXECUTED_AT = COALESCE(EXECUTED_AT, EXECUTED_TS)
WHERE EXECUTED_AT IS NULL;
